"use strict";var Oe=Object.defineProperty;var Pt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var Tt=Object.prototype.hasOwnProperty;var oe=(e,t)=>{for(var o in t)Oe(e,o,{get:t[o],enumerable:!0})},Mt=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Et(t))!Tt.call(e,r)&&r!==o&&Oe(e,r,{get:()=>t[r],enumerable:!(n=Pt(t,r))||n.enumerable});return e};var At=e=>Mt(Oe({},"__esModule",{value:!0}),e);var zt={};oe(zt,{ChildOf:()=>ee,IsA:()=>q,Not:()=>Ct,Pair:()=>_,ParentOf:()=>Ke,Prefab:()=>E,SYMBOLS:()=>Gt,Types:()=>we,Wildcard:()=>h,addComponent:()=>ht,addComponents:()=>bt,addEntity:()=>We,archetypeHash:()=>V,commitRemovals:()=>ze,createWorld:()=>rt,defineComponent:()=>dt,defineEnterQueue:()=>St,defineExitQueue:()=>$t,definePrefab:()=>Ft,defineQuery:()=>ce,defineRelation:()=>Se,defineSystem:()=>Wt,defineWorld:()=>Be,deleteWorld:()=>it,enterQuery:()=>ct,entityExists:()=>qe,exitQuery:()=>ft,flushRemovedEntities:()=>ot,getAllEntities:()=>mt,getChild:()=>Nt,getChildren:()=>Ht,getEntityComponents:()=>Me,getEntityCursor:()=>Ee,getParent:()=>jt,getPrefab:()=>Lt,getPrefabEid:()=>Yt,getRecycledEntities:()=>nt,getRelationTargets:()=>$e,getStore:()=>R,getWorldComponents:()=>at,hasComponent:()=>B,pipe:()=>Qt,query:()=>Y,registerComponent:()=>$,registerComponents:()=>xt,registerPrefab:()=>Ae,registerQuery:()=>me,registerWorld:()=>_e,removeComponent:()=>G,removeComponents:()=>gt,removeEntity:()=>ge,removeQuery:()=>ut,resetWorld:()=>st,setStore:()=>yt,withParams:()=>_t,worlds:()=>A});module.exports=At(zt);var ke={};oe(ke,{$componentCount:()=>ne,$componentToInstance:()=>c,$createStore:()=>xe,$onAdd:()=>D,$onRegister:()=>Qe,$onRemove:()=>re,$onReset:()=>z,$onSet:()=>K});var c=Symbol("componentToInstance"),ne=Symbol("componentCount"),D=Symbol("onAdd"),re=Symbol("onRemove"),z=Symbol("onReset"),K=Symbol("onSet"),Qe=Symbol("onRegister"),xe=Symbol("createStore");var Ue={};oe(Ue,{$dirtyQueries:()=>P,$enterQuery:()=>It,$exitQuery:()=>Dt,$hashToUncachedQuery:()=>X,$modifier:()=>O,$notQueries:()=>k,$queries:()=>v,$queriesHashMap:()=>U,$queryComponents:()=>se,$queryDataMap:()=>l,$querySparseSet:()=>qt,$queueRegisters:()=>J});var O=Symbol("$modifier"),v=Symbol("queries"),k=Symbol("notQueries"),X=Symbol("hashToUncachedQuery"),U=Symbol("queriesHashMap"),qt=Symbol("querySparseSet"),J=Symbol("queueRegisters"),l=Symbol("queryDataMap"),P=Symbol("$dirtyQueries"),se=Symbol("queryComponents"),It=Symbol("enterQuery"),Dt=Symbol("exitQuery");var V=(e,t)=>t.sort((o,n)=>{O in o&&(o=o[0]),O in n&&(n=n[0]),e[c].has(o)||$(e,o),e[c].has(n)||$(e,n);let r=e[c].get(o),i=e[c].get(n);return r.id>i.id?1:-1}).reduce((o,n)=>{let r=null,i;O in n?(r=n[1],i=n[0]):i=n,e[c].has(i)||$(e,i);let m=e[c].get(i);return r?o+=`-${r}(${m.id})`:o+=`-${m.id}`,o},"");var je=(e,t)=>(e[t.generationId]||(e[t.generationId]=0),e[t.generationId]|=t.bitflag,e),Ne=(e,t)=>{let o=[],n=[],r=!1;for(let u of t){if(O in u){let b=u[0],De=u[1];e[c].has(b)||$(e,b),De==="not"&&n.push(b)}else e[c].has(u)||$(e,u),o.push(u);u===E&&(r=!0)}let i=u=>e[c].get(u),m=o.concat(n).map(i),s=m.map(u=>u.generationId).reduce((u,b)=>(u.includes(b)||u.push(b),u),[]),a=o.map(i).reduce(je,{}),p=n.map(i).reduce(je,{}),f=m.reduce(je,{});return{generations:s,masks:a,notMasks:p,hasMasks:f,instances:m,queriesPrefab:r}},He=(e,t)=>{let o=V(e,t),n;return e[X].has(o)?n=e[X].get(o):(n=Ne(e,t),e[X].set(o,n)),n};var Q=()=>{let e=[],t=[],o=s=>e[t[s]]===s;return{add:s=>{o(s)||(t[s]=e.push(s)-1)},remove:s=>{if(!o(s))return;let a=t[s],p=e.pop();p!==s&&(e[a]=p,t[p]=a)},has:o,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0},sort:()=>{e.sort((s,a)=>s-a);for(let s=0;s<e.length;s++)t[e[s]]=s}}};var Fe={};oe(Fe,{$entityArray:()=>j,$entityComponents:()=>S,$entityIndices:()=>Ot,$entityMasks:()=>g,$entitySparseSet:()=>C,$removedEntities:()=>kt});var g=Symbol("entityMasks"),S=Symbol("entityComponents"),C=Symbol("entitySparseSet"),j=Symbol("entityArray"),Ot=Symbol("entityIndices"),kt=Symbol("removedEntities");var we={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"};var io={uint8:2**8,uint16:2**16,uint32:2**32},pe=Object.freeze([]);var Ye={};oe(Ye,{$bitflag:()=>T,$eidToPrefab:()=>M,$entityCursor:()=>ae,$localEntities:()=>ie,$localEntityLookup:()=>Z,$recycled:()=>H,$removed:()=>w,$removedOut:()=>N});var T=Symbol("bitflag"),ie=Symbol("localEntities"),Z=Symbol("localEntityLookup"),ae=Symbol("entityCursor"),w=Symbol("removed"),N=Symbol("removedOut"),H=Symbol("recycled"),M=Symbol("eidToPrefab");var y=(e,t,o)=>Object.defineProperty(e,t,{value:o,enumerable:!1,writable:!0,configurable:!0}),Re=(e,t)=>{let o={enumerable:!1,writable:!0,configurable:!0};Object.defineProperties(e,Reflect.ownKeys(t).reduce((n,r)=>Object.assign(n,{[r]:{value:t[r],...o}}),{}))};var Le={};oe(Le,{$autoRemoveSubject:()=>be,$component:()=>Pe,$exclusiveRelation:()=>he,$isPairComponent:()=>W,$onTargetRemoved:()=>ue,$pairTarget:()=>d,$pairsMap:()=>ve,$relation:()=>x,$relationTargetEntities:()=>F});var ve=Symbol("pairsMap"),W=Symbol("isPairComponent"),x=Symbol("relation"),d=Symbol("pairTarget"),ue=Symbol("onTargetRemoved"),he=Symbol("exclusiveRelation"),be=Symbol("autoRemoveSubject"),F=Symbol("relationTargetEntities"),Pe=Symbol("component");var A=[],et=e=>{if(e[N].length===0)for(;e[w].length>0;)e[N].push(e[w].pop());if(e[N].length===0)throw new Error("Queue is empty");return e[N].pop()},tt=e=>e[w].length+e[N].length,ot=e=>{e[w].push(...e[H]),e[H].length=0},Ee=e=>e[ae],nt=e=>e[H];function Be(e){let t=Q();return Re(e,{[g]:[new Array],[S]:new Map,[C]:t,[j]:t.dense,[T]:1,[c]:new Map,[ne]:0,[l]:new Map,[v]:new Set,[X]:new Map,[U]:new Map,[k]:new Set,[P]:new Set,[ie]:new Map,[Z]:new Map,[F]:new Set,[ae]:0,[w]:[],[N]:[],[H]:[],[M]:new Map}),e}function _e(e){A.push(e),Ge.forEach(t=>me(e,t))}function rt(e){let t=Be(e??{});return _e(t),t}var st=e=>(e[j]&&e[j].forEach(t=>ge(e,t)),e[g]=[new Array],e[S]=new Map,e[C]=Q(),e[j]=e[C].dense,e[T]=1,e[c]=new Map,e[ne]=0,e[l]=new Map,e[v]=new Set,e[U]=new Map,e[k]=new Set,e[P]=new Set,e[ie]=new Map,e[Z]=new Map,e[M]=new Map,e),it=e=>{let t=e;delete t[g],delete t[S],delete t[C],delete t[j],delete t[T],delete t[c],delete t[ne],delete t[l],delete t[v],delete t[U],delete t[k],delete t[P],delete t[ie],delete t[Z],delete t[F],delete t[ae],delete t[w],delete t[N],delete t[H],delete t[M],delete t[X];let o=A.indexOf(e);o!==-1&&A.splice(o,1)},at=e=>Array.from(e[c].keys()),mt=e=>e[C].dense.slice(0),pt=e=>{e[T]*=2,e[T]>=2**31&&(e[T]=1,e[g].push(new Array))},Te=(e,t)=>e[C].has(t);var Ge=[],me=(e,t)=>{if(e[l].has(t))return;let o=Q(),n=Q(),r=[Q()],i=[Q()],m=Object.assign(o,{...Ne(e,t[se]),toRemove:n,enterQueues:r,exitQueues:i,query:t});e[l].set(t,m),e[v].add(m);let s=V(e,t[se]);e[U].set(s,m),m.instances.forEach(a=>{a.queries.add(m)}),Object.values(m.notMasks).length>0&&e[k].add(m),t[J].forEach(a=>a(e));for(let a=0;a<Ee(e);a++){if(!e[C].has(a)||!m.queriesPrefab&&B(e,a,E))continue;L(e,m,a)&&fe(m,a)}},ce=e=>{if(e===void 0){let o=function(n){return n[j].slice()};return o[se]=e,o[J]=[],o}let t=function(o){let n=o[l].get(t);return ze(o),n.dense.slice()};return t[se]=e,t[J]=[],Ge.push(t),A.forEach(o=>me(o,t)),t};function Y(e,t){if(Array.isArray(t)){let o=t,n=V(e,o),r=e[U].get(n);return r?r.query(e):ce(o)(e)}else return t(e).slice()}var L=(e,t,o)=>{for(let n=0;n<t.generations.length;n++){let r=t.generations[n],i=t.masks[r],m=t.notMasks[r],s=e[g][r][o];if(m&&s&m||i&&(s&i)!==i)return!1}return!0};var fe=(e,t)=>{e.toRemove.remove(t);for(let o=0;o<e.enterQueues.length;o++)e.enterQueues[o].add(t);for(let o=0;o<e.exitQueues.length;o++)e.exitQueues[o].remove(t);e.add(t)},Ut=e=>{for(let t=e.toRemove.dense.length-1;t>=0;t--){let o=e.toRemove.dense[t];e.toRemove.remove(o),e.remove(o)}},ze=e=>{e[P].size&&(e[P].forEach(Ut),e[P].clear())},Ce=(e,t,o)=>{if(!(!t.has(o)||t.toRemove.has(o))){t.toRemove.add(o),e[P].add(t);for(let r=0;r<t.exitQueues.length;r++)t.exitQueues[r].add(o);for(let r=0;r<t.enterQueues.length;r++)t.enterQueues[r].remove(o)}},ut=(e,t)=>{let o=e[l].get(t);e[v].delete(o),e[l].delete(t);let n=V(e,t[se]);e[U].delete(n)},ct=e=>t=>{t[l].has(e)||me(t,e);let o=t[l].get(e);if(o.enterQueues[0].dense.length===0)return pe;{let n=o.enterQueues[0].dense.slice();return o.enterQueues[0].reset(),n}},ft=e=>t=>{t[l].has(e)||me(t,e);let o=t[l].get(e);if(o.exitQueues[0].dense.length===0)return pe;{let n=o.exitQueues[0].dense.slice();return o.exitQueues[0].reset(),n}};function lt(e,t,o,n){if(!o.has(n)){let r=t();y(r,W,!0),y(r,x,e),y(r,d,n),o.set(n,r)}return o.get(n)}var Se=e=>{let t={exclusive:!1,autoRemoveSubject:!1},o=()=>({}),n=null;e?.component&&(o=e.component),e?.exclusive&&(t.exclusive=e.exclusive??!1),e?.autoRemoveSubject&&(t.autoRemoveSubject=e.autoRemoveSubject??!1),e?.onTargetRemoved&&(n=e.onTargetRemoved);let r=new Map,i=function(m){if(m===void 0)throw Error("Relation target is undefined");return m==="*"&&(m=h),lt(i,o,r,m)};return y(i,ve,r),y(i,Pe,o),y(i,he,t.exclusive),y(i,be,t.autoRemoveSubject),y(i,ue,n),i},_=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");if(t===void 0)throw Error("Relation target is undefined");t==="*"&&(t=h);let o=e[ve],n=e[Pe];return lt(e,n,o,t)},h=Se(),q=Se(),ee=Se({exclusive:!0,autoRemoveSubject:!0}),Ke=Se({}),$e=(e,t,o)=>{let n=Me(e,o),r=[];for(let i of n)i[x]===t&&i[d]!==h&&r.push(i[d]);return r},jt=(e,t)=>$e(e,ee,t)[0],Nt=(e,t,o)=>{let n=o?.components||[],r=He(e,n),i=m=>{let s=Y(e,[ee(m)]);if(s.length)for(let a=0;a<s.length;a+=1){let p=s[a];if(L(e,r,p))return p;o?.deep&&i(p)}};return i(t)},Ht=(e,t,o)=>{let n=o?.components||[],r=He(e,n),i=new Set,m=s=>{let a=Y(e,[ee(s)]);if(a.length)for(let p=0;p<a.length;p+=1){let f=a[p];L(e,r,f)&&i.add(f),o?.deep&&m(f)}};return m(t),Array.from(i)};var Xe={};oe(Xe,{$ancestors:()=>ye,$children:()=>I,$prefabComponents:()=>le,$worldToEid:()=>te});var le=Symbol("prefabComponents"),te=Symbol("worldToEid"),I=Symbol("children"),ye=Symbol("ancestors");var E={},Ft=e=>{let t=e?.ref??{},o=[],n=[],r=[];if(e?.components)for(let m of e?.components){let s,a;if(Array.isArray(m)?(s=m[0],a=m[1]):s=m,s[W]){let p=s[x];if(p===q){let f=s[d];o.push(f)}else if(p===ee){let f=s[d];typeof f=="object"&&te in f&&f[I].push(t)}else if(p===Ke){let f=s[d];r.push(f)}}else n.push(m)}e?.onSet&&y(t,K,e.onSet),e?.onAdd&&y(t,D,e.onAdd),e?.onRemove&&y(t,re,e.onRemove);let i=[];for(let m of o)i.push(...m[ye]);return i.push(t),Re(t,{[le]:n,[te]:new Map,[ye]:i,[I]:r}),t},Ae=(e,t)=>{if(t[te].has(e))return t[te].get(e);let o=We(e,E,...t[le]);return t[te].set(e,o),e[M].set(o,t),o},Yt=(e,t)=>t[te].get(e),Lt=(e,t)=>e[M].get(t);var We=(e,...t)=>{let o;return tt(e)>0?o=et(e):o=e[ae]++,e[C].add(o),e[k].forEach(n=>{L(e,n,o)&&fe(n,o)}),e[S].set(o,new Set),Ie(e,o,t),o},ge=(e,t,o=!1)=>{if(e[C].has(t)){B(e,t,E)&&e[M].delete(t);for(let n of e[S].get(t))n[W]&&n[d]!==h?o&&n[x][z]?.(e,R(e,n),t):o&&n[z]?.(e,R(e,n),t);if(e[F].has(t)){for(let n of Y(e,[_(h,t)]))if(qe(e,n)){G(e,n,_(h,t),o);for(let r of e[S].get(n)){if(!r[W]||!qe(e,n))continue;let i=r[x];r[d]===t&&(i[be]?ge(e,n,o):G(e,n,r,o),i[ue]&&i[ue](e,n,t))}}}for(let n of e[v])Ce(e,n,t);e[H].push(t),e[C].remove(t),e[S].delete(t),e[ie].delete(e[Z].get(t)),e[Z].delete(t);for(let n=0;n<e[g].length;n++)e[g][n][t]=0}},Me=(e,t)=>{if(!e[C].has(t))throw new Error("bitECS - entity does not exist in the world.");return e[S].get(t)},qe=(e,t)=>e[C].has(t),Je=(e,t,o)=>{for(let n of o){let r=We(e,q(n),ee(t));n[I].length&&Je(e,r,n[I])}};var R=(e,t)=>(e[c].has(t)||$(e,t),e[c].get(t).store),yt=(e,t,o)=>{e[c].has(t)||$(e,t);let n=e[c].get(t);n.store=o};function dt(e){let t=e?.ref||{};return e?.store&&y(t,xe,e.store),e?.onSet&&y(t,K,e.onSet),e?.onReset&&y(t,z,e.onReset),e?.onAdd&&y(t,D,e.onAdd),e?.onRemove&&y(t,re,e.onRemove),e?.onRegister&&y(t,Qe,e.onRegister),t}var $=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let o={id:e[ne]++,generationId:e[g].length-1,bitflag:e[T],ref:t,store:t[xe]?t[xe]():t,queries:new Set,notQueries:new Set};e[c].set(t,o),pt(e);let n=t[Qe];n&&n(e,R(e,t))},xt=(e,t)=>{t.forEach(o=>$(e,o))},B=(e,t,o)=>{let n=e[c].get(o);if(!n)return!1;let{generationId:r,bitflag:i}=n;return(e[g][r][t]&i)===i},ht=(e,t,o)=>{if(!Te(e,t))throw new Error("bitECS - entity does not exist in the world.");Ie(e,t,[o])};function bt(e,t,...o){if(!Te(e,t))throw new Error("bitECS - entity does not exist in the world.");Ie(e,t,o)}var Ie=(e,t,o)=>{let n=new Map,r=new Set,i=new Map,m=[];for(let s of o){let a,p;if(Array.isArray(s)?(a=s[0],p=s[1]):a=s,!a[W]){i.set(a,p);continue}let f=a[x];i.set(_(f,h),void 0);let u=a[d];if(i.set(_(h,u),void 0),a[x]===q){let b=a[d];n.set(b,p),b[I]&&m.push(...b[I]);let De=b[ye];for(let Ze of De){r.add(Ze);for(let de of Ze[le])if(Array.isArray(de)){let Rt=de[0],vt=de[1];i.set(Rt,vt)}else i.has(de)||i.set(de,void 0)}}else i.set(a,void 0)}for(let s of i.entries()){let a=s[0],p=s[1];if(Ve(e,t,a),a[x]&&a[d]!==h){let f=a[D];f&&f(e,t);let u=a[x][K];u&&u(e,R(e,a),t,p)}else{let f=a[D];f&&f(e,t);let u=a[K];u&&u(e,R(e,a),t,p)}}for(let s of n){let a=s[0],p=s[1];Ae(e,a),Ve(e,t,q(a)),a[D]?.(e,t),a[K]?.(e,t,p)}for(let s of r)n.has(s)||(Ae(e,s),Ve(e,t,q(s)),s[D]?.(e,t));Je(e,t,m)},Ve=(e,t,o)=>{if(B(e,t,o))return;e[c].has(o)||$(e,o);let n=e[c].get(o),{generationId:r,bitflag:i,queries:m}=n;if(e[g][r][t]|=i,B(e,t,E)||m.forEach(s=>{s.toRemove.remove(t),L(e,s,t)?fe(s,t):Ce(e,s,t)}),e[S].get(t).add(o),o[W]){let s=o[x],a=o[d];if(e[F].add(a),s[he]===!0&&a!==h){let p=$e(e,s,t)[0];p!=null&&p!==a&&G(e,t,s(p))}}},G=(e,t,o,n=!0)=>{if(!Te(e,t))throw new Error("bitECS - entity does not exist in the world.");if(!B(e,t,o))return;let r=e[c].get(o),{generationId:i,bitflag:m,queries:s}=r;if(e[g][i][t]&=~m,s.forEach(a=>{a.toRemove.remove(t),L(e,a,t)?fe(a,t):Ce(e,a,t)}),e[S].get(t).delete(o),o[W]){Y(e,[h(t)]).length===0&&e[F].delete(t);let a=o[d];G(e,t,_(h,a));let p=o[x];$e(e,p,t).length===0&&G(e,t,_(p,h));let u=p[z],b=o[re];(o[x]===q||o[d]!==h)&&(b&&b(e,t),n&&u&&u(e,R(e,o),t))}else{let a=o[re];a&&a(e,t);let p=o[z];n&&p&&p(e,R(e,o),t)}},gt=(e,t,o)=>{o.forEach(n=>G(e,t,n))};function Bt(e,t){let o=[e,t];return o[O]=!0,o}var Ct=e=>Bt(e,"not");function St(e){let t=typeof e=="function"?e:ce(e),o=-1,n=i=>{let m=i[l].get(t);m&&(o=m.enterQueues.push(Q())-1)};for(let i of A)n(i);let r=(i,m=!0)=>{let s=i[l].get(t);if(s.enterQueues[o].dense.length===0)return pe;{let a=s.enterQueues[o].dense.slice();return m&&s.enterQueues[o].reset(),a}};return t[J].push(n),r}function $t(e){let t=typeof e=="function"?e:ce(e),o=-1,n=i=>{let m=i[l].get(t);m&&(o=m.exitQueues.push(Q())-1)};for(let i of A)n(i);let r=(i,m=!0)=>{let s=i[l].get(t);if(s.exitQueues[o].dense.length===0)return pe;{let a=s.exitQueues[o].dense.slice();return m&&s.exitQueues[o].reset(),a}};return t[J].push(n),r}var Wt=e=>(t,...o)=>(e(t,...o),t);var Qt=(...e)=>t=>{let o=t;for(let n=0;n<e.length;n++){let r=e[n];o=r(o)}return o};function _t(e,t){return[e,t]}var Gt={...Ye,...Fe,...ke,...Ue,...Le,...Xe};0&&(module.exports={ChildOf,IsA,Not,Pair,ParentOf,Prefab,SYMBOLS,Types,Wildcard,addComponent,addComponents,addEntity,archetypeHash,commitRemovals,createWorld,defineComponent,defineEnterQueue,defineExitQueue,definePrefab,defineQuery,defineRelation,defineSystem,defineWorld,deleteWorld,enterQuery,entityExists,exitQuery,flushRemovedEntities,getAllEntities,getChild,getChildren,getEntityComponents,getEntityCursor,getParent,getPrefab,getPrefabEid,getRecycledEntities,getRelationTargets,getStore,getWorldComponents,hasComponent,pipe,query,registerComponent,registerComponents,registerPrefab,registerQuery,registerWorld,removeComponent,removeComponents,removeEntity,removeQuery,resetWorld,setStore,withParams,worlds});
