var rt=Object.defineProperty;var ae=(e,t)=>{for(var o in t)rt(e,o,{get:t[o],enumerable:!0})};var Ae={};ae(Ae,{$componentCount:()=>ee,$componentToInstance:()=>c,$createStore:()=>de,$onAdd:()=>A,$onRegister:()=>Ce,$onRemove:()=>te,$onReset:()=>L,$onSet:()=>B});var c=Symbol("componentToInstance"),ee=Symbol("componentCount"),A=Symbol("onAdd"),te=Symbol("onRemove"),L=Symbol("onReset"),B=Symbol("onSet"),Ce=Symbol("onRegister"),de=Symbol("createStore");var qe={};ae(qe,{$dirtyQueries:()=>v,$enterQuery:()=>it,$exitQuery:()=>at,$hashToUncachedQuery:()=>_,$modifier:()=>q,$notQueries:()=>I,$queries:()=>R,$queriesHashMap:()=>D,$queryComponents:()=>oe,$queryDataMap:()=>l,$querySparseSet:()=>st,$queueRegisters:()=>G});var q=Symbol("$modifier"),R=Symbol("queries"),I=Symbol("notQueries"),_=Symbol("hashToUncachedQuery"),D=Symbol("queriesHashMap"),st=Symbol("querySparseSet"),G=Symbol("queueRegisters"),l=Symbol("queryDataMap"),v=Symbol("$dirtyQueries"),oe=Symbol("queryComponents"),it=Symbol("enterQuery"),at=Symbol("exitQuery");var ne=(e,t)=>t.sort((o,n)=>{q in o&&(o=o[0]),q in n&&(n=n[0]),e[c].has(o)||$(e,o),e[c].has(n)||$(e,n);let a=e[c].get(o),s=e[c].get(n);return a.id>s.id?1:-1}).reduce((o,n)=>{let a=null,s;q in n?(a=n[1],s=n[0]):s=n,e[c].has(s)||$(e,s);let m=e[c].get(s);return a?o+=`-${a}(${m.id})`:o+=`-${m.id}`,o},"");var Ie=(e,t)=>(e[t.generationId]||(e[t.generationId]=0),e[t.generationId]|=t.bitflag,e),De=(e,t)=>{let o=[],n=[],a=!1;for(let u of t){if(q in u){let h=u[0],Me=u[1];e[c].has(h)||$(e,h),Me==="not"&&n.push(h)}else e[c].has(u)||$(e,u),o.push(u);u===O&&(a=!0)}let s=u=>e[c].get(u),m=o.concat(n).map(s),r=m.map(u=>u.generationId).reduce((u,h)=>(u.includes(h)||u.push(h),u),[]),i=o.map(s).reduce(Ie,{}),p=n.map(s).reduce(Ie,{}),f=m.reduce(Ie,{});return{generations:r,masks:i,notMasks:p,hasMasks:f,instances:m,queriesPrefab:a}},Oe=(e,t)=>{let o=ne(e,t),n;return e[_].has(o)?n=e[_].get(o):(n=De(e,t),e[_].set(o,n)),n};var Q=()=>{let e=[],t=[],o=r=>e[t[r]]===r;return{add:r=>{o(r)||(t[r]=e.push(r)-1)},remove:r=>{if(!o(r))return;let i=t[r],p=e.pop();p!==r&&(e[i]=p,t[p]=i)},has:o,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0},sort:()=>{e.sort((r,i)=>r-i);for(let r=0;r<e.length;r++)t[e[r]]=r}}};var ke={};ae(ke,{$entityArray:()=>k,$entityComponents:()=>S,$entityIndices:()=>mt,$entityMasks:()=>b,$entitySparseSet:()=>g,$removedEntities:()=>pt});var b=Symbol("entityMasks"),S=Symbol("entityComponents"),g=Symbol("entitySparseSet"),k=Symbol("entityArray"),mt=Symbol("entityIndices"),pt=Symbol("removedEntities");var ut={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"};var Gt={uint8:2**8,uint16:2**16,uint32:2**32},me=Object.freeze([]);var Ue={};ae(Ue,{$bitflag:()=>P,$eidToPrefab:()=>E,$entityCursor:()=>se,$localEntities:()=>re,$localEntityLookup:()=>z,$recycled:()=>j,$removed:()=>K,$removedOut:()=>U});var P=Symbol("bitflag"),re=Symbol("localEntities"),z=Symbol("localEntityLookup"),se=Symbol("entityCursor"),K=Symbol("removed"),U=Symbol("removedOut"),j=Symbol("recycled"),E=Symbol("eidToPrefab");var y=(e,t,o)=>Object.defineProperty(e,t,{value:o,enumerable:!1,writable:!0,configurable:!0}),Se=(e,t)=>{let o={enumerable:!1,writable:!0,configurable:!0};Object.defineProperties(e,Reflect.ownKeys(t).reduce((n,a)=>Object.assign(n,{[a]:{value:t[a],...o}}),{}))};var je={};ae(je,{$autoRemoveSubject:()=>he,$component:()=>We,$exclusiveRelation:()=>xe,$isPairComponent:()=>W,$onTargetRemoved:()=>pe,$pairTarget:()=>d,$pairsMap:()=>$e,$relation:()=>x,$relationTargetEntities:()=>N});var $e=Symbol("pairsMap"),W=Symbol("isPairComponent"),x=Symbol("relation"),d=Symbol("pairTarget"),pe=Symbol("onTargetRemoved"),xe=Symbol("exclusiveRelation"),he=Symbol("autoRemoveSubject"),N=Symbol("relationTargetEntities"),We=Symbol("component");var H=[],Ke=e=>{if(e[U].length===0)for(;e[K].length>0;)e[U].push(e[K].pop());if(e[U].length===0)throw new Error("Queue is empty");return e[U].pop()},Xe=e=>e[K].length+e[U].length,ct=e=>{e[K].push(...e[j]),e[j].length=0},Ne=e=>e[se],ft=e=>e[j];function Je(e){let t=Q();return Se(e,{[b]:[new Array],[S]:new Map,[g]:t,[k]:t.dense,[P]:1,[c]:new Map,[ee]:0,[l]:new Map,[R]:new Set,[_]:new Map,[D]:new Map,[I]:new Set,[v]:new Set,[re]:new Map,[z]:new Map,[N]:new Set,[se]:0,[K]:[],[U]:[],[j]:[],[E]:new Map}),e}function Ve(e){H.push(e),He.forEach(t=>ue(e,t))}function lt(e){let t=Je(e??{});return Ve(t),t}var yt=e=>(e[k]&&e[k].forEach(t=>Re(e,t)),e[b]=[new Array],e[S]=new Map,e[g]=Q(),e[k]=e[g].dense,e[P]=1,e[c]=new Map,e[ee]=0,e[l]=new Map,e[R]=new Set,e[D]=new Map,e[I]=new Set,e[v]=new Set,e[re]=new Map,e[z]=new Map,e[E]=new Map,e),dt=e=>{let t=e;delete t[b],delete t[S],delete t[g],delete t[k],delete t[P],delete t[c],delete t[ee],delete t[l],delete t[R],delete t[D],delete t[I],delete t[v],delete t[re],delete t[z],delete t[N],delete t[se],delete t[K],delete t[U],delete t[j],delete t[E],delete t[_];let o=H.indexOf(e);o!==-1&&H.splice(o,1)},xt=e=>Array.from(e[c].keys()),ht=e=>e[g].dense.slice(0),Ze=e=>{e[P]*=2,e[P]>=2**31&&(e[P]=1,e[b].push(new Array))},Qe=(e,t)=>e[g].has(t);var He=[],ue=(e,t)=>{if(e[l].has(t))return;let o=Q(),n=Q(),a=[Q()],s=[Q()],m=Object.assign(o,{...De(e,t[oe]),toRemove:n,enterQueues:a,exitQueues:s,query:t});e[l].set(t,m),e[R].add(m);let r=ne(e,t[oe]);e[D].set(r,m),m.instances.forEach(i=>{i.queries.add(m)}),Object.values(m.notMasks).length>0&&e[I].add(m),t[G].forEach(i=>i(e));for(let i=0;i<Ne(e);i++){if(!e[g].has(i)||!m.queriesPrefab&&J(e,i,O))continue;F(e,m,i)&&ce(m,i)}},be=e=>{if(e===void 0){let o=function(n){return n[k].slice()};return o[oe]=e,o[G]=[],o}let t=function(o){let n=o[l].get(t);return we(o),n.dense.slice()};return t[oe]=e,t[G]=[],He.push(t),H.forEach(o=>ue(o,t)),t};function X(e,t){if(Array.isArray(t)){let o=t,n=ne(e,o),a=e[D].get(n);return a?a.query(e):be(o)(e)}else return t(e).slice()}var F=(e,t,o)=>{for(let n=0;n<t.generations.length;n++){let a=t.generations[n],s=t.masks[a],m=t.notMasks[a],r=e[b][a][o];if(m&&r&m||s&&(r&s)!==s)return!1}return!0};var ce=(e,t)=>{e.toRemove.remove(t);for(let o=0;o<e.enterQueues.length;o++)e.enterQueues[o].add(t);for(let o=0;o<e.exitQueues.length;o++)e.exitQueues[o].remove(t);e.add(t)},bt=e=>{for(let t=e.toRemove.dense.length-1;t>=0;t--){let o=e.toRemove.dense[t];e.toRemove.remove(o),e.remove(o)}},we=e=>{e[v].size&&(e[v].forEach(bt),e[v].clear())},ge=(e,t,o)=>{if(!(!t.has(o)||t.toRemove.has(o))){t.toRemove.add(o),e[v].add(t);for(let a=0;a<t.exitQueues.length;a++)t.exitQueues[a].add(o);for(let a=0;a<t.enterQueues.length;a++)t.enterQueues[a].remove(o)}},gt=(e,t)=>{let o=e[l].get(t);e[R].delete(o),e[l].delete(t);let n=ne(e,t[oe]);e[D].delete(n)},Ct=e=>t=>{t[l].has(e)||ue(t,e);let o=t[l].get(e);if(o.enterQueues[0].dense.length===0)return me;{let n=o.enterQueues[0].dense.slice();return o.enterQueues[0].reset(),n}},St=e=>t=>{t[l].has(e)||ue(t,e);let o=t[l].get(e);if(o.exitQueues[0].dense.length===0)return me;{let n=o.exitQueues[0].dense.slice();return o.exitQueues[0].reset(),n}};function et(e,t,o,n){if(!o.has(n)){let a=t();y(a,W,!0),y(a,x,e),y(a,d,n),o.set(n,a)}return o.get(n)}var ve=e=>{let t={exclusive:!1,autoRemoveSubject:!1},o=()=>({}),n=null;e?.component&&(o=e.component),e?.exclusive&&(t.exclusive=e.exclusive??!1),e?.autoRemoveSubject&&(t.autoRemoveSubject=e.autoRemoveSubject??!1),e?.onTargetRemoved&&(n=e.onTargetRemoved);let a=new Map,s=function(m){if(m===void 0)throw Error("Relation target is undefined");return m==="*"&&(m=C),et(s,o,a,m)};return y(s,$e,a),y(s,We,o),y(s,xe,t.exclusive),y(s,he,t.autoRemoveSubject),y(s,pe,n),s},V=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");if(t===void 0)throw Error("Relation target is undefined");t==="*"&&(t=C);let o=e[$e],n=e[We];return et(e,n,o,t)},C=ve(),Y=ve(),ie=ve({exclusive:!0,autoRemoveSubject:!0}),tt=ve({}),Pe=(e,t,o)=>{let n=Fe(e,o),a=[];for(let s of n)s[x]===t&&s[d]!==C&&a.push(s[d]);return a},Qo=(e,t)=>Pe(e,ie,t)[0],Ro=(e,t,o)=>{let n=o?.components||[],a=Oe(e,n),s=m=>{let r=X(e,[ie(m)]);if(r.length)for(let i=0;i<r.length;i+=1){let p=r[i];if(F(e,a,p))return p;o?.deep&&s(p)}};return s(t)},vo=(e,t,o)=>{let n=o?.components||[],a=Oe(e,n),s=new Set,m=r=>{let i=X(e,[ie(r)]);if(i.length)for(let p=0;p<i.length;p+=1){let f=i[p];F(e,a,f)&&s.add(f),o?.deep&&m(f)}};return m(t),Array.from(s)};var Ye={};ae(Ye,{$ancestors:()=>le,$children:()=>T,$prefabComponents:()=>fe,$worldToEid:()=>Z});var fe=Symbol("prefabComponents"),Z=Symbol("worldToEid"),T=Symbol("children"),le=Symbol("ancestors");var O={},Oo=e=>{let t=e?.ref??{},o=[],n=[],a=[];if(e?.components)for(let m of e?.components){let r,i;if(Array.isArray(m)?(r=m[0],i=m[1]):r=m,r[W]){let p=r[x];if(p===Y){let f=r[d];o.push(f)}else if(p===ie){let f=r[d];typeof f=="object"&&Z in f&&f[T].push(t)}else if(p===tt){let f=r[d];a.push(f)}}else n.push(m)}e?.onSet&&y(t,B,e.onSet),e?.onAdd&&y(t,A,e.onAdd),e?.onRemove&&y(t,te,e.onRemove);let s=[];for(let m of o)s.push(...m[le]);return s.push(t),Se(t,{[fe]:n,[Z]:new Map,[le]:s,[T]:a}),t},Le=(e,t)=>{if(t[Z].has(e))return t[Z].get(e);let o=Ee(e,O,...t[fe]);return t[Z].set(e,o),e[E].set(o,t),o},ko=(e,t)=>t[Z].get(e),Uo=(e,t)=>e[E].get(t);var Ee=(e,...t)=>{let o;return Xe(e)>0?o=Ke(e):o=e[se]++,e[g].add(o),e[I].forEach(n=>{F(e,n,o)&&ce(n,o)}),e[S].set(o,new Set),Te(e,o,t),o},Re=(e,t,o=!1)=>{if(e[g].has(t)){J(e,t,O)&&e[E].delete(t);for(let n of e[S].get(t))n[W]&&n[d]!==C?o&&n[x][L]?.(e,M(e,n),t):o&&n[L]?.(e,M(e,n),t);if(e[N].has(t)){for(let n of X(e,[V(C,t)]))if(Be(e,n)){w(e,n,V(C,t),o);for(let a of e[S].get(n)){if(!a[W]||!Be(e,n))continue;let s=a[x];a[d]===t&&(s[he]?Re(e,n,o):w(e,n,a,o),s[pe]&&s[pe](e,n,t))}}}for(let n of e[R])ge(e,n,t);e[j].push(t),e[g].remove(t),e[S].delete(t),e[re].delete(e[z].get(t)),e[z].delete(t);for(let n=0;n<e[b].length;n++)e[b][n][t]=0}},Fe=(e,t)=>{if(!e[g].has(t))throw new Error("bitECS - entity does not exist in the world.");return e[S].get(t)},Be=(e,t)=>e[g].has(t),_e=(e,t,o)=>{for(let n of o){let a=Ee(e,Y(n),ie(t));n[T].length&&_e(e,a,n[T])}};var M=(e,t)=>(e[c].has(t)||$(e,t),e[c].get(t).store),$t=(e,t,o)=>{e[c].has(t)||$(e,t);let n=e[c].get(t);n.store=o};function Wt(e){let t=e?.ref||{};return e?.store&&y(t,de,e.store),e?.onSet&&y(t,B,e.onSet),e?.onReset&&y(t,L,e.onReset),e?.onAdd&&y(t,A,e.onAdd),e?.onRemove&&y(t,te,e.onRemove),e?.onRegister&&y(t,Ce,e.onRegister),t}var $=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let o={id:e[ee]++,generationId:e[b].length-1,bitflag:e[P],ref:t,store:t[de]?t[de]():t,queries:new Set,notQueries:new Set};e[c].set(t,o),Ze(e);let n=t[Ce];n&&n(e,M(e,t))},Qt=(e,t)=>{t.forEach(o=>$(e,o))},J=(e,t,o)=>{let n=e[c].get(o);if(!n)return!1;let{generationId:a,bitflag:s}=n;return(e[b][a][t]&s)===s},Rt=(e,t,o)=>{if(!Qe(e,t))throw new Error("bitECS - entity does not exist in the world.");Te(e,t,[o])};function vt(e,t,...o){if(!Qe(e,t))throw new Error("bitECS - entity does not exist in the world.");Te(e,t,o)}var Te=(e,t,o)=>{let n=new Map,a=new Set,s=new Map,m=[];for(let r of o){let i,p;if(Array.isArray(r)?(i=r[0],p=r[1]):i=r,!i[W]){s.set(i,p);continue}let f=i[x];s.set(V(f,C),void 0);let u=i[d];if(s.set(V(C,u),void 0),i[x]===Y){let h=i[d];n.set(h,p),h[T]&&m.push(...h[T]);let Me=h[le];for(let ze of Me){a.add(ze);for(let ye of ze[fe])if(Array.isArray(ye)){let ot=ye[0],nt=ye[1];s.set(ot,nt)}else s.has(ye)||s.set(ye,void 0)}}else s.set(i,void 0)}for(let r of s.entries()){let i=r[0],p=r[1];if(Ge(e,t,i),i[x]&&i[d]!==C){let f=i[A];f&&f(e,t);let u=i[x][B];u&&u(e,M(e,i),t,p)}else{let f=i[A];f&&f(e,t);let u=i[B];u&&u(e,M(e,i),t,p)}}for(let r of n){let i=r[0],p=r[1];Le(e,i),Ge(e,t,Y(i)),i[A]?.(e,t),i[B]?.(e,t,p)}for(let r of a)n.has(r)||(Le(e,r),Ge(e,t,Y(r)),r[A]?.(e,t));_e(e,t,m)},Ge=(e,t,o)=>{if(J(e,t,o))return;e[c].has(o)||$(e,o);let n=e[c].get(o),{generationId:a,bitflag:s,queries:m}=n;if(e[b][a][t]|=s,J(e,t,O)||m.forEach(r=>{r.toRemove.remove(t),F(e,r,t)?ce(r,t):ge(e,r,t)}),e[S].get(t).add(o),o[W]){let r=o[x],i=o[d];if(e[N].add(i),r[xe]===!0&&i!==C){let p=Pe(e,r,t)[0];p!=null&&p!==i&&w(e,t,r(p))}}},w=(e,t,o,n=!0)=>{if(!Qe(e,t))throw new Error("bitECS - entity does not exist in the world.");if(!J(e,t,o))return;let a=e[c].get(o),{generationId:s,bitflag:m,queries:r}=a;if(e[b][s][t]&=~m,r.forEach(i=>{i.toRemove.remove(t),F(e,i,t)?ce(i,t):ge(e,i,t)}),e[S].get(t).delete(o),o[W]){X(e,[C(t)]).length===0&&e[N].delete(t);let i=o[d];w(e,t,V(C,i));let p=o[x];Pe(e,p,t).length===0&&w(e,t,V(p,C));let u=p[L],h=o[te];(o[x]===Y||o[d]!==C)&&(h&&h(e,t),n&&u&&u(e,M(e,o),t))}else{let i=o[te];i&&i(e,t);let p=o[L];n&&p&&p(e,M(e,o),t)}},Pt=(e,t,o)=>{o.forEach(n=>w(e,t,n))};function Et(e,t){let o=[e,t];return o[q]=!0,o}var Tt=e=>Et(e,"not");function Mt(e){let t=typeof e=="function"?e:be(e),o=-1,n=s=>{let m=s[l].get(t);m&&(o=m.enterQueues.push(Q())-1)};for(let s of H)n(s);let a=(s,m=!0)=>{let r=s[l].get(t);if(r.enterQueues[o].dense.length===0)return me;{let i=r.enterQueues[o].dense.slice();return m&&r.enterQueues[o].reset(),i}};return t[G].push(n),a}function At(e){let t=typeof e=="function"?e:be(e),o=-1,n=s=>{let m=s[l].get(t);m&&(o=m.exitQueues.push(Q())-1)};for(let s of H)n(s);let a=(s,m=!0)=>{let r=s[l].get(t);if(r.exitQueues[o].dense.length===0)return me;{let i=r.exitQueues[o].dense.slice();return m&&r.exitQueues[o].reset(),i}};return t[G].push(n),a}var qt=e=>(t,...o)=>(e(t,...o),t);var It=(...e)=>t=>{let o=t;for(let n=0;n<e.length;n++){let a=e[n];o=a(o)}return o};function Cn(e,t){return[e,t]}var $n={...Ue,...ke,...Ae,...qe,...je,...Ye};export{ie as ChildOf,Y as IsA,Tt as Not,V as Pair,tt as ParentOf,O as Prefab,$n as SYMBOLS,ut as Types,C as Wildcard,Rt as addComponent,vt as addComponents,Ee as addEntity,ne as archetypeHash,we as commitRemovals,lt as createWorld,Wt as defineComponent,Mt as defineEnterQueue,At as defineExitQueue,Oo as definePrefab,be as defineQuery,ve as defineRelation,qt as defineSystem,Je as defineWorld,dt as deleteWorld,Ct as enterQuery,Be as entityExists,St as exitQuery,ct as flushRemovedEntities,ht as getAllEntities,Ro as getChild,vo as getChildren,Fe as getEntityComponents,Ne as getEntityCursor,Qo as getParent,Uo as getPrefab,ko as getPrefabEid,ft as getRecycledEntities,Pe as getRelationTargets,M as getStore,xt as getWorldComponents,J as hasComponent,It as pipe,X as query,$ as registerComponent,Qt as registerComponents,Le as registerPrefab,ue as registerQuery,Ve as registerWorld,w as removeComponent,Pt as removeComponents,Re as removeEntity,gt as removeQuery,yt as resetWorld,$t as setStore,Cn as withParams,H as worlds};
